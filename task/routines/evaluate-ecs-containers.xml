<tree schema_version="1.0">
    <sourceName>-</sourceName>
    <sourceGroup>-</sourceGroup>
    <definitionId>routine_evaluate_ecs_containers_v1</definitionId>
    <type>Global Routine</type>
    <status>Active</status>
    <taskTree builder_version="" schema_version="1.0" version="">
        <name>Evaluate ECS Containers</name>
        <author></author>
        <notes></notes>
        <lastID>29</lastID>
        <taskDefinition id="routine_evaluate_ecs_containers_v1" name="Evaluate ECS Containers" schema_version="1.0" version="1">
            <visible>false</visible>
            <deferrable>true</deferrable>
            <parameters>
                <parameter id="Schedule Another Run" label="Schedule Another Run" required="false" tooltip="Will schedule another run if set to True">False</parameter>
                <parameter id="Schedule Delay" label="Schedule Delay" required="false" tooltip="Number of minutes delay for the next scheduled run">720</parameter>
                <parameter id="Number of Recurring Runs" label="Number of Recurring Runs" required="false" tooltip="Number of times to schedule another run (-1 to recur forever)">1</parameter>
            </parameters>
            <handler name="system_tree_call" version="1"></handler>
            <results format="xml">
                <result name="Spaces With Missing Tasks" tooltip="Spaces that are missing an ECS Task"></result>
                <result name="Orphaned Tasks" tooltip="Tasks that don't correlate to any spaces"></result>
            </results>
        </taskDefinition>
        <request>
            <task definition_id="system_start_v1" id="start" name="Start" x="10" y="10">
                <version>1</version>
                <configured>true</configured>
                <defers>false</defers>
                <deferrable>false</deferrable>
                <visible>false</visible>
                <parameters></parameters>
                <messages></messages>
                <dependents>
                    <task label="" type="Complete" value="">routine_kd_retrieve_active_kinops_environments_10</task>
                </dependents>
            </task>
            <task definition_id="utilities_echo_v1" id="utilities_echo_v1_3" name="Calculate Results" x="557" y="22">
                <version>1</version>
                <configured>true</configured>
                <defers>false</defers>
                <deferrable>false</deferrable>
                <visible>true</visible>
                <parameters>
                    <parameter id="input" label="Input" menu="" required="true" tooltip="">&lt;%
excluded_spaces = %w( manage )

spaces = {}
JSON.parse(@results['Retrieve Active Spaces']['Environments']).each do |space|
  space_slug = space['values']['Space Slug']
  unless excluded_spaces.include?(space_slug)
    spaces[space_slug] = { 
      'engine_type' =&gt; space['values']['Shared Workflow Engine'] == 'True' ? 'Shared' : 'Dedicated',
      'tasks' =&gt; [],
      'uses_response' =&gt; space['values']['Uses Response'].to_s.downcase == 'true'
    }
  end
end

orphaned_containers = {}
JSON.parse(@results['Retrieve ECS Tasks']['Tasks']).each do |task|
  if spaces.has_key?(task['space_slug'])
    if task['container_name'] == 'Response'
      if spaces[task['space_slug']]['uses_response']
        spaces[task['space_slug']]['tasks'] &lt;&lt; task 
      else
        if orphaned_containers.has_key?(task['space_slug'])
          orphaned_containers[task['space_slug']] &lt;&lt; task
        else
          orphaned_containers[task['space_slug']] = [ task ]
        end
      end
    else
      spaces[task['space_slug']]['tasks'] &lt;&lt; task
    end
  else
    if orphaned_containers.has_key?(task['space_slug'])
      orphaned_containers[task['space_slug']] &lt;&lt; task
    else
      orphaned_containers[task['space_slug']] = [ task ]
    end
  end
end

spaces_missing_containers = {}
spaces.each do |slug,data|
  has_task = false
  has_response = false
  data['tasks'].each do |task|
    if task['container_name'] == 'Response'
      has_response = true
    end
    if task['container_name'] == 'Task'
      has_task = true
    end
  end

  if data['uses_response'] &amp;&amp; !has_response
    if spaces_missing_containers.has_key?(slug)
      spaces_missing_containers[slug] &lt;&lt; 'Response'
    else
      spaces_missing_containers[slug] = [ 'Response' ]
    end
  end
  if data['engine_type'] == 'Dedicated' &amp;&amp; !has_task
    if spaces_missing_containers.has_key?(slug)
      spaces_missing_containers[slug] &lt;&lt; 'Task'
    else
      spaces_missing_containers[slug] = [ 'Task' ]
    end
  end
end
%&gt;
&lt;%= {
  'missing' =&gt; spaces_missing_containers,
  'orphaned' =&gt; orphaned_containers
}.to_json %&gt;</parameter>
                </parameters>
                <messages>
                    <message type="Create"></message>
                    <message type="Update"></message>
                    <message type="Complete"></message>
                </messages>
                <dependents>
                    <task label="" type="Complete" value="">utilities_echo_v1_20</task>
                    <task label="" type="Complete" value="">utilities_echo_v1_21</task>
                    <task label="Schedule Another Run" type="Complete" value="@inputs['Schedule Another Run'].to_s.downcase == 'true' &amp;&amp; (@inputs['Number of Recurring Runs'].to_i == -1 || @inputs['Number of Recurring Runs'].to_i &gt; 0)">system_wait_v1_4</task>
                </dependents>
            </task>
            <task definition_id="system_wait_v1" id="system_wait_v1_4" name="Schedule Another Run" x="819" y="11">
                <version>1</version>
                <configured>true</configured>
                <defers>true</defers>
                <deferrable>true</deferrable>
                <visible>true</visible>
                <parameters>
                    <parameter id="Time to wait" label="Wait time:" menu="" required="true" tooltip="Time you want to wait for deferred task">&lt;%=@inputs['Schedule Delay'].to_i &gt; 0 ? @inputs['Schedule Delay'].to_i : 720%&gt;</parameter>
                    <parameter id="Time unit" label="Time unit:" menu="Second,Minute,Hour,Day,Week" required="true" tooltip="Unit of measurement for time (Seconds, Minutes, Hours, Days, Weeks)">Minute</parameter>
                </parameters>
                <messages>
                    <message type="Create"></message>
                    <message type="Update"></message>
                    <message type="Complete"></message>
                </messages>
                <dependents>
                    <task label="" type="Complete" value="">routine_evaluate_ecs_containers_v1_29</task>
                </dependents>
            </task>
            <task definition_id="routine_kd_notification_send_using_template_v1" id="routine_kd_notification_send_using_template_v1_8" name="Notify Kinops Admins" x="561" y="337">
                <version>1</version>
                <configured>true</configured>
                <defers>false</defers>
                <deferrable>true</deferrable>
                <visible>false</visible>
                <parameters>
                    <parameter id="Recipient List" label="Recipient List" menu="" required="true" tooltip="Comma separated list of recipients (Usernames, SMTP Addresses, and/or Team Names)">james.davies@kineticdata.com,jack.boespflug@kineticdata.com</parameter>
                    <parameter id="Notification Template Name" label="Notification Template Name" menu="" required="true" tooltip="Name of the notification template to use when sending this email">Evaluate ECS Containers</parameter>
                    <parameter id="JSON Vars" label="JSON Vars" menu="" required="false" tooltip="JSON input of miscellaneous values.  These values are used to replace placeholder content in notification messages.">&lt;%
missing_html = "&lt;div&gt;&lt;ul&gt;"
JSON.parse(@results['Missing']['output']).each do |space_slug,tasks|
  tasks.each do |container_name|
    missing_html += "&lt;li&gt;&lt;a href=\"https://kinops.io/manage/support#/spaces/#{space_slug}\" target=\"_blank\"&gt;#{space_slug} - #{container_name}&lt;/a&gt;&lt;/li&gt;"
  end
end
missing_html += "&lt;/ul&gt;&lt;/div&gt;"

orphaned_html = "&lt;div&gt;&lt;ul&gt;"
JSON.parse(@results['Orphaned']['output']).each do |space_slug,tasks|
  tasks.each do |task|
    orphaned_html += "&lt;li&gt;#{space_slug} - #{task['container_name']} - &lt;a href=\"https://console.aws.amazon.com/ecs/home?region=us-east-1#/clusters/kinops/tasks/#{task['id']}/details\" target=\"_blank\"&gt;#{task['id']}&lt;/a&gt;&lt;/li&gt;"
  end
end
orphaned_html += "&lt;/ul&gt;&lt;/div&gt;"
%&gt;
&lt;%=
{
    "Timestamp" =&gt; Time.now.utc,
    "Missing" =&gt; missing_html,
    "Orphaned" =&gt; orphaned_html
}.to_json
%&gt;
</parameter>
                    <parameter id="System" label="System" menu="" required="false" tooltip="System to search for ID. Defaults to Request">kinops</parameter>
                    <parameter id="Space Slug" label="Space Slug" menu="" required="true" tooltip="Space Slug of the submission to get values for. Used to retrieve Request submissions, notification templates, users.">manage</parameter>
                    <parameter id="ID" label="ID" menu="" required="false" tooltip="Id of the submission to get values for, required if using those or attachments in the message"></parameter>
                    <parameter id="Admin Kapp Slug" label="Admin Kapp Slug" menu="" required="true" tooltip="Slug of this spaces admin kapp (typically admin)">admin</parameter>
                    <parameter id="Kapp Slug Initiating Notification" label="Kapp Slug Initiating Notification" menu="" required="true" tooltip="The slug of the Kapp sending the notification (ex: catalog, queue, etc.)">support</parameter>
                </parameters>
                <messages>
                    <message type="Create"></message>
                    <message type="Update"></message>
                    <message type="Complete"></message>
                </messages>
                <dependents></dependents>
            </task>
            <task definition_id="routine_kd_retrieve_active_kinops_environments" id="routine_kd_retrieve_active_kinops_environments_10" name="Retrieve Active Spaces" x="187" y="14">
                <version>1</version>
                <configured>true</configured>
                <defers>true</defers>
                <deferrable>true</deferrable>
                <visible>false</visible>
                <parameters></parameters>
                <messages>
                    <message type="Create"></message>
                    <message type="Update"></message>
                    <message type="Complete"></message>
                </messages>
                <dependents>
                    <task label="" type="Complete" value="">routine_retrieve_ecs_cluster_tasks_v1_13</task>
                </dependents>
            </task>
            <task definition_id="routine_retrieve_ecs_cluster_tasks_v1" id="routine_retrieve_ecs_cluster_tasks_v1_13" name="Retrieve ECS Tasks" x="333" y="21">
                <version>1</version>
                <configured>true</configured>
                <defers>true</defers>
                <deferrable>true</deferrable>
                <visible>false</visible>
                <parameters>
                    <parameter id="S3 Bucket" label="S3 Bucket" menu="" required="true" tooltip="">private.kinops.io</parameter>
                    <parameter id="S3 Filename" label="S3 Filename" menu="" required="true" tooltip="">aws_credentials.csv</parameter>
                    <parameter id="AWS Region" label="AWS Region" menu="" required="true" tooltip="">us-east-1</parameter>
                    <parameter id="ECS Cluster" label="ECS Cluster" menu="" required="true" tooltip="">kinops</parameter>
                    <parameter id="Env Name" label="Env Name" menu="" required="true" tooltip="">space_slug</parameter>
                </parameters>
                <messages>
                    <message type="Create"></message>
                    <message type="Update"></message>
                    <message type="Complete"></message>
                </messages>
                <dependents>
                    <task label="" type="Complete" value="">utilities_echo_v1_3</task>
                </dependents>
            </task>
            <task definition_id="utilities_echo_v1" id="utilities_echo_v1_20" name="Missing" x="690" y="121">
                <version>1</version>
                <configured>true</configured>
                <defers>false</defers>
                <deferrable>false</deferrable>
                <visible>true</visible>
                <parameters>
                    <parameter id="input" label="Input" menu="" required="true" tooltip="">&lt;%=JSON.parse(@results['Calculate Results']['output'])['missing'].to_json%&gt;</parameter>
                </parameters>
                <messages>
                    <message type="Create"></message>
                    <message type="Update"></message>
                    <message type="Complete"></message>
                </messages>
                <dependents>
                    <task label="" type="Complete" value="">system_junction_v1_24</task>
                </dependents>
            </task>
            <task definition_id="utilities_echo_v1" id="utilities_echo_v1_21" name="Orphaned" x="445" y="125">
                <version>1</version>
                <configured>true</configured>
                <defers>false</defers>
                <deferrable>false</deferrable>
                <visible>true</visible>
                <parameters>
                    <parameter id="input" label="Input" menu="" required="true" tooltip="">&lt;%=JSON.parse(@results['Calculate Results']['output'])['orphaned'].to_json%&gt;</parameter>
                </parameters>
                <messages>
                    <message type="Create"></message>
                    <message type="Update"></message>
                    <message type="Complete"></message>
                </messages>
                <dependents>
                    <task label="" type="Complete" value="">system_junction_v1_24</task>
                </dependents>
            </task>
            <task definition_id="system_tree_return_v1" id="system_tree_return_v1_23" name="Return" x="1053" y="29">
                <version>1</version>
                <configured>true</configured>
                <defers>false</defers>
                <deferrable>false</deferrable>
                <visible>false</visible>
                <parameters>
                    <parameter id="Spaces With Missing Tasks" label="Spaces With Missing Tasks" menu="" required="false" tooltip="Spaces that are missing an ECS Task">&lt;%=@results['Missing']['output'].to_json%&gt;</parameter>
                    <parameter id="Orphaned Tasks" label="Orphaned Tasks" menu="" required="false" tooltip="Tasks that don't correlate to any spaces">&lt;%=@results['Orphaned']['output'].to_json%&gt;</parameter>
                </parameters>
                <messages>
                    <message type="Create"></message>
                    <message type="Update"></message>
                    <message type="Complete"></message>
                </messages>
                <dependents></dependents>
            </task>
            <task definition_id="system_junction_v1" id="system_junction_v1_24" name="Junction" x="561" y="193">
                <version>1</version>
                <configured>true</configured>
                <defers>false</defers>
                <deferrable>false</deferrable>
                <visible>false</visible>
                <parameters></parameters>
                <messages>
                    <message type="Create"></message>
                    <message type="Update"></message>
                    <message type="Complete"></message>
                </messages>
                <dependents>
                    <task label="Problem Found" type="Complete" value="JSON.parse(@results['Orphaned']['output']).size &gt; 0 || JSON.parse(@results['Missing']['output']).size &gt; 0">routine_kd_notification_send_using_template_v1_8</task>
                </dependents>
            </task>
            <task definition_id="routine_evaluate_ecs_containers_v1" id="routine_evaluate_ecs_containers_v1_29" name="Evaluate ECS Containers" x="939" y="13">
                <version>1</version>
                <configured>true</configured>
                <defers>true</defers>
                <deferrable>true</deferrable>
                <visible>false</visible>
                <parameters>
                    <parameter id="Schedule Another Run" label="Schedule Another Run" menu="" required="false" tooltip="Will schedule another run if set to True">&lt;%=@inputs['Schedule Another Run'] || 'False'%&gt;</parameter>
                    <parameter id="Schedule Delay" label="Schedule Delay" menu="" required="false" tooltip="Number of minutes delay for the next scheduled run">&lt;%=@inputs['Schedule Delay']%&gt;</parameter>
                    <parameter id="Number of Recurring Runs" label="Number of Recurring Runs" menu="" required="false" tooltip="Number of times to schedule another run (-1 to run recur forever)">&lt;% times = @inputs['Number of Recurring Runs'].to_i %&gt;
&lt;%= times == -1 ? -1 : times &gt; 0 ? times-1 : 0 %&gt;</parameter>
                </parameters>
                <messages>
                    <message type="Create"></message>
                    <message type="Update"></message>
                    <message type="Complete"></message>
                </messages>
                <dependents>
                    <task label="" type="Complete" value="">system_tree_return_v1_23</task>
                </dependents>
            </task>
        </request>
    </taskTree>
</tree>